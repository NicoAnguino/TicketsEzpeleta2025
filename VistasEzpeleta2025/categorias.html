<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Categorías</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 50%; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        input, button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h2>Listado de Categorías</h2>

    <table id="tablaCategorias">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Crear Categoría</h3>
    <input type="text" id="nuevaCategoriaNombre" placeholder="Nombre">
    <button onclick="createCategoria()">Crear</button>

    <h3>Editar Categoría</h3>
    <input type="number" id="editarCategoriaId" placeholder="ID">
    <input type="text" id="editarCategoriaNombre" placeholder="Nuevo Nombre">
    <button onclick="updateCategoria()">Actualizar</button>

    <script>
        const API_URL = "http://localhost:5268/api/categorias";

        const getToken = () => localStorage.getItem("token");

        const authHeaders = () => ({
            "Content-Type": "application/json",
            "Authorization": `Bearer ${getToken()}`
        });

        async function getCategorias() {
            const res = await fetch(API_URL);
            const categorias = await res.json();
            const tbody = document.querySelector("#tablaCategorias tbody");
            tbody.innerHTML = "";

            categorias.forEach(cat => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${cat.categoriaID}</td>
                    <td>${cat.nombre}</td>
                    <td>
                        <button onclick="prepararEdicion(${cat.categoriaID}, '${cat.nombre}')">Editar</button>
                        <button onclick="deleteCategoria(${cat.categoriaID})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function prepararEdicion(id, nombre) {
            document.getElementById("editarCategoriaId").value = id;
            document.getElementById("editarCategoriaNombre").value = nombre;
        }

        async function createCategoria() {
            const nombre = document.getElementById("nuevaCategoriaNombre").value;

            const res = await fetch(API_URL, {
                method: "POST",
                headers: authHeaders(),
                body: JSON.stringify({ nombre })
            });

            if (res.ok) {
                alert("Categoría creada");
                getCategorias();
            } else {
                alert("Error al crear: " + await res.text());
            }
        }

        async function updateCategoria() {
            const id = document.getElementById("editarCategoriaId").value;
            const nombre = document.getElementById("editarCategoriaNombre").value;

            const res = await fetch(`${API_URL}/${id}`, {
                method: "PUT",
                headers: authHeaders(),
                body: JSON.stringify({ categoriaID: id, nombre })
            });

            if (res.ok) {
                alert("Categoría actualizada");
                getCategorias();
            } else {
                alert("Error al actualizar: " + await res.text());
            }
        }

        async function deleteCategoria(id) {
            if (!confirm("¿Seguro que querés eliminar esta categoría?")) return;

            const res = await fetch(`${API_URL}/${id}`, {
                method: "DELETE",
                headers: authHeaders()
            });

            if (res.ok) {
                alert("Categoría eliminada");
                getCategorias();
            } else {
                alert("Error al eliminar: " + await res.text());
            }
        }

        // Cargar categorías al iniciar
        getCategorias();
    </script>
</body>
</html>